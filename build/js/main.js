define("api",[],function(){var a="./api/v1/storage",b="./open",c={login:a+"?action=login",getFileList:a+"?action=get_server_file_list",mkdir:a+"?action=mkdir",rmfile:a+"?action=rm_file",rename:a+"?action=rename",upload:a+"?action=upload",download:b,moveFile:a+"?action=move_file"};return c}),define("app",["jquery","lib/jquery.hashchange","util/hash","util/user","util/cookie","util/ajax","api","util/login","util/work","util/file","util/adaptor","util/upload","util/tool"],function(a){var b=a("jquery");a("lib/jquery.hashchange")(b);var c=a("util/hash"),d=a("util/user"),e=a("util/login"),f=a("util/work"),g=a("util/upload");a("util/tool"),b(window).hashchange(function(){var a=c.get();switch(a.type){case"login":d.isLogin()?c.set("work"):e.show();break;case"work":d.isLogin()?(b(".wrapper").show(),b(".userArea span").html(d.username),f.init(a.path)):c.set("login");break;default:c.set("work")}}),b(".jsLogout").on("click",function(){d.logout()}),b(".jsBack").on("click",function(){if(!b(this).hasClass("disable")){var a=c.get().path;a.pop(),c.set("work/"+a.join("/"))}}),b(".upload a").on("click",function(){g.init()}),b("body").on("click",".popup .close",function(){b(this).parents(".popup").remove()}),b(window).hashchange()}),define("lib/jquery.hashchange",[],function(){return function(a){!function(a,b,c){"$:nomunge";function d(a){return a=a||location.href,"#"+a.replace(/^[^#]*#?(.*)$/,"$1")}var e,f="hashchange",g=document,h=a.event.special,i=g.documentMode,j="on"+f in b&&(i===c||i>7);a.fn[f]=function(a){return a?this.bind(f,a):this.trigger(f)},a.fn[f].delay=50,h[f]=a.extend(h[f],{setup:function(){return j?!1:void a(e.start)},teardown:function(){return j?!1:void a(e.stop)}}),e=function(){function e(){var c=d(),g=n(k);c!==k?(m(k=c,g),a(b).trigger(f)):g!==k&&(location.href=location.href.replace(/#.*/,"")+g),h=setTimeout(e,a.fn[f].delay)}var h,i={},k=d(),l=function(a){return a},m=l,n=l;i.start=function(){h||e()},i.stop=function(){h&&clearTimeout(h),h=c};var o=function(){for(var a,b=3,c=document.createElement("div"),d=c.getElementsByTagName("i");c.innerHTML="<!--[if gt IE "+ ++b+"]><i></i><![endif]-->",d[0];);return b>4?b:a}();return o&&!j&&function(){var b,c;i.start=function(){b||(c=a.fn[f].src,c=c&&c+d(),b=a('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){c||m(d()),e()}).attr("src",c||"javascript:0").insertAfter("body")[0].contentWindow,g.onpropertychange=function(){try{"title"===event.propertyName&&(b.document.title=g.title)}catch(a){}})},i.stop=l,n=function(){return d(b.location.href)},m=function(c,d){var e=b.document,h=a.fn[f].domain;c!==d&&(e.title=g.title,e.open(),h&&e.write('<script>document.domain="'+h+'"</script>'),e.close(),b.location.hash=c)}}(),i}()}(a,window)}}),define("util/adaptor",["jquery"],function(a){function b(){var a=c(".jsCopy"),b=c(".jsMove"),d=c(".jsDelete"),e=c(".jsRename"),f=c(".jsDownload"),g=null;this.set=function(c,h){a.removeClass("disable"),b.removeClass("disable"),d.removeClass("disable"),e.removeClass("disable"),f.removeClass("disable"),c&&"object"==typeof c?("dir"==c.type&&(f.addClass("disable"),a.addClass("disable")),g={},g.$el=h,g.obj=c):(a.addClass("disable"),b.addClass("disable"),d.addClass("disable"),e.addClass("disable"),f.addClass("disable"),g=null)},this.destroy=function(){this.set(null)},this.get=function(){return g}}var c=a("jquery");return new b}),define("util/ajax",["jquery"],function(a){function b(a){var b=c.extend(!0,{type:"GET",dataType:"json",success:function(){},error:function(){}},a);c.ajax(b)}var c=a("jquery");return b}),define("util/cookie",[],function(){function a(a){for(var c in a)b[c]=a[c]}var b={encode:!1,decode:!1,path:!1,domain:!1,duration:!1,secure:!1,document:document},c={write:function(c,d,e){if(a(e),b.encode&&(d=encodeURIComponent(d)),b.domain&&(d+="; domain="+b.domain),b.path&&(d+="; path="+b.path),b.duration){var f=new Date;f.setTime(f.getTime()+24*b.duration*36e5),d+="; expires="+f.toGMTString()}return b.secure&&(d+="; secure"),b.document.cookie=c+"="+d,this},read:function(a){var c=b.document.cookie.match("(?:^|;)\\s*"+a.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")+"=([^;]*)");return b.decode?c?decodeURIComponent(c[1]):null:c?c[1]:null},remove:function(d,e){return a(e),b.duration=-1,c.write(d,""),this}};return c}),define("util/file",["jquery","underscore","util/adaptor","util/hash","api"],function(a){function b(a){var b="unknow-icon";if("dir"==a.type)b="folder-icon";else{var c=/\.[^\.]+$/.exec(a.name);switch(c&&(c=c[0]),c){case".pdf":b="pdf-icon";break;case".doc":b="word-icon";break;case".xls":b="xls-icon";break;case".zip":b="zip-icon";break;default:b="unknow-icon"}}return b}function c(a){var c=e(j({fileIcon:b(a),fileName:a.name}));return c.on("mouseenter",function(){e(this).addClass("hover")}).on("mouseleave",function(){e(this).removeClass("hover")}).on("click",function(){e(this).siblings().removeClass("click"),e(this).addClass("click"),g.set(a,e(this))}).on("dblclick",function(){"dir"==a.type?h.set("work"+a.path):window.open(i.download+a.path)}),c}function d(){this.init=function(a){k.children("ul").html("");for(var b=0;b<a.length;b++){var c=a[b];if(!c.status){for(;"/"==c.path.substr(0,1)&&"/"==c.path.substr(1,1);)c.path=c.path.substr(1);this.add(c)}}},this.add=function(a){var b=c(a);k.children("ul").append(b)}}var e=a("jquery"),f=a("underscore"),g=a("util/adaptor"),h=a("util/hash"),i=a("api"),j=f.template(e("#file_template").html()),k=e(".file-con");return new d}),define("util/hash",[],function(){function a(){var a={type:"",path:[]},b=window.location.hash;0===b.indexOf("#")&&(b=b.substr(1)),/\/$/.test(b)&&(b=b.substr(0,b.length-1));var c=b.indexOf("/");return-1==c?a.type=b:(a.type=b.substring(0,c),b.substr(c+1)&&(a.path=b.substr(c+1).split("/"))),a}return{get:function(){return a()},set:function(a){window.location.hash=a}}}),define("util/login",["jquery","util/user","util/cookie","util/ajax","api","util/hash"],function(a){var b=a("jquery"),c=a("util/user"),d=a("util/hash"),e=function(){var a=b("#login_template").html(),e=b(".wrapper"),f=b(".login-wrapper");this.show=function(){e.hide();var g=b(a);f.html(g);var h=this;g.find(".jsLogin").on("click",function(){var a=g.find("input[type=text]").val(),e=g.find("input[type=password]").val(),f=b(this);f.parent().addClass("loading"),c.login(a,e,function(){h.remove(),d.set("work")},function(){f.parent().removeClass("loading"),g.find(".error-msg").html("密码错误").show()})}),g.find("input[type=password]").on("focus",function(){g.find(".error-msg").hide()})},this.remove=function(){f.html("")}};return new e}),define("util/tool",["jquery","util/adaptor","util/hash","api","util/ajax","util/user","util/cookie","util/file","underscore"],function(a){var b=a("jquery"),c=a("util/adaptor"),d=a("util/hash"),e=a("api"),f=a("util/ajax"),g=a("util/user"),h=a("util/file"),i=a("underscore"),j='<div class="popup"><div class="pop-input"><input type="text" placeholder="请输入名称" /><div><a href="javascript:;" class="btnType1 jsSubmit load-hidden">确定</a><img class="loading-img" src="images/loading.gif" /></div><a href="javascript:;" class="close">x</a></div></div>',k='<div class="popup"><div class="popwrap"><p>复制到：</p><div class="move-wrap"><%= listdata %></div><a href="javascript:;" class="close">x</a><div><a href="javascript:;" class="btnType1 jsSubmit load-hidden">确定</a><img class="loading-img" src="images/loading.gif" /></div></div></div>',l="<ul><% _.each(data, function(item){ if(item.type=='dir'){ while(item.path.substr(0,1)=='/' && item.path.substr(1,1)=='/'){item.path.substr(1)} %>"+'<li><div class="filelist" data-path="<%= item.path %>"><i class="icon-arrow"></i><span><%= item.name %></span></div></li><% }}) %></ul>',m=b(".jsCopy"),n=(b(".jsMove"),b(".jsDelete")),o=b(".jsRename"),p=b(".jsDownload"),q=b(".jsNew"),r=b(".file-con");m.on("click",function(){if(!b(this).hasClass("disable")){var a=i.template(l,{variable:"data"})([{name:"我的私有云",path:"/",type:"dir"}]),d=b(i.template(k)({listdata:a})),h=null,j=!1;b("body").append(d),d.on("click",".jsSubmit",function(){if(h){b(this).parent().addClass("loading");var a=c.get().obj,i="/"==h.attr("data-path")?h.attr("data-path")+a.name:h.attr("data-path")+"/"+a.name;f({url:e.moveFile,data:{token:g.token,from_path:a.path,to_path:i},success:function(a){d.remove(),0==a.status||alert("接口出错，请稍后再试")},error:function(){d.remove()}})}}),d.on("click",".filelist",function(){j||(h&&h.removeClass("select"),h=b(this),h.addClass("select"),h.parent().hasClass("empty")||(h.parent().hasClass("open")?h.parent().removeClass("open"):h.parent().hasClass("loaded")?h.parent().addClass("open"):(h.parent().addClass("loading"),j=!0,f({url:e.getFileList,data:{path:h.attr("data-path"),token:g.token},success:function(a){if(j=!1,h.parent().removeClass("loading"),a&&0!=a.length){for(var b=0,c=0;c<a.length;c++)"dir"==a[c].type&&b++;b?h.parent().addClass("loaded").addClass("open").append(i.template(l,{variable:"data"})(a)):h.parent().addClass("empty").addClass("loaded")}else h.parent().addClass("empty").addClass("loaded")},error:function(){j=!1,h.parent().removeClass("loading").addClass("empty"),alert("接口出错，请稍后再试")}}))))})}}),o.on("click",function(){if(!b(this).hasClass("disable")){var a=c.get(),h=b(j);b("body").append(h);var i=h.find("input[type=text]");i.val(a.obj.name),h.find(".jsSubmit").on("click",function(){if(""!=i.val()){b(this).parent().addClass("loading");var c=i.val(),j="/"+d.get().path.join("/")+"/"+c;f({url:e.rename,data:{old_dir:a.obj.path,new_dir:j,token:g.token},success:function(b){h.remove(),0==b.status?a.$el.find(".filename").html(c):alert("接口出错，请稍后再试")},error:function(){h.remove(),alert("接口出错，请稍后再试")}})}})}}),q.on("click",function(){if(!b(this).hasClass("disable")){var a=b(j);b("body").append(a),a.find(".jsSubmit").on("click",function(){var c=a.find("input[type=text]");if(""!=c.val()){b(this).parent().addClass("loading");var i="/"+d.get().path.join("/")+"/"+c.val();f({url:e.mkdir,data:{dir:i,token:g.token},success:function(b){a.remove(),0==b.status?h.add({status:0,name:c.val(),path:i,type:"dir"}):alert("接口出错，请稍后再试")},error:function(){a.remove(),alert("接口出错，请稍后再试")}})}})}}),p.on("click",function(){if(!b(this).hasClass("disable")){var a=c.get().obj;window.open(e.download+a.path)}}),n.on("click",function(){if(!b(this).hasClass("disable")){var a=c.get();r.addClass("loading"),f({url:e.rmfile,data:{dir:a.obj.path,token:g.token},success:function(b){r.removeClass("loading"),0==b.status?a.$el.remove():alert("接口出错，请稍后再试")},error:function(){r.removeClass("loading"),alert("接口出错，请稍后再试")}})}})}),define("util/upload",["jquery","api","util/user","util/cookie","util/ajax","util/hash","util/file","util/adaptor"],function(a){function b(){this.init=function(){var a=d(i),b={status:0,type:"file"};d("body").append(a),a.find("input[type=file]").on("change",function(){var h=d(this),i=c(h.val()),j="/",k=g.get().path;k&&0!=k.length?j=j+k.join("/")+"/"+i:j+=i,b.name=i,b.path=j;var l=e.upload+"&token="+f.token+"&path="+j;a.find("form").attr("action",l)}),a.find("input[type=submit]").on("click",function(){d(this).parent().addClass("loading")}),a.find("#uploadtg").on("load",function(){a.remove(),h.add(b)})}}function c(a){var b=/[^\\\/]*[\\\/]+/g;return a=a.replace(b,"")}var d=a("jquery"),e=a("api"),f=a("util/user"),g=a("util/hash"),h=a("util/file"),i='<div class="popup"><div class="pop-upload"><form method="post" enctype="multipart/form-data" target="uploadtg"><input type="file" name="file" /><div class="upsubmit"><input type="submit" value="上传" class="load-hidden" /><img class="loading-img" src="images/loading.gif" /></div></form><iframe name="uploadtg" id="uploadtg" width="0" height="0"></iframe><a href="javascript:;" class="close">x</a></div></div>';return new b}),define("util/user",["util/cookie","util/ajax","api","util/hash"],function(a){var b=a("util/cookie"),c=a("util/ajax"),d=a("api"),e=a("util/hash"),f=function(){this.username=b.read("username"),this.token=b.read("token"),this.isLogin=function(){var a=this.username||b.read("username"),c=this.token||b.read("token");return a&&c?!0:!1},this.login=function(a,e,f,g){var h=this;c({url:d.login,type:"POST",data:{user_name:a,password:e},success:function(c){0==c.status&&c.token?(b.write("username",a,{duration:7}),b.write("token",c.token,{duration:7}),h.username=a,h.token=c.token,f&&f()):g&&g()},error:function(){g&&g()}})},this.logout=function(){b.remove("username"),b.remove("token"),this.username=null,this.token=null,e.set("login")}};return new f}),define("util/work",["jquery","util/file","util/adaptor","util/hash","api","util/user","util/cookie","util/ajax"],function(a){function b(){var a=c(".jsBack"),b=c(".file-con");this.init=function(c){c&&c.length&&c[0]&&"/"!=c[0]||(c=[]),0==c.length?a.addClass("disable"):a.removeClass("disable"),e.destroy(),b.addClass("loading"),h({url:f.getFileList,data:{path:"/"+c.join("/"),token:g.token},success:function(a){b.removeClass("loading"),a&&a.length&&a.length>0&&d.init(a)}})}}var c=a("jquery"),d=a("util/file"),e=a("util/adaptor"),f=a("api"),g=a("util/user"),h=a("util/ajax");return new b});